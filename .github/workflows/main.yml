# This is a basic workflow to help you get started with Actions

name: build_task

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  issues:
    types: [opened, reopened]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-20.04

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    - name: Checkout
      uses: actions/checkout@master
      
    - name: ParseIssue
      id: parse
      uses: peter-murray/issue-forms-body-parser@v2.0.0
      with:
        issue_id: ${{ github.event.issue.number }}
        separator: '###'
        label_marker_start: '>>'
        label_marker_end: '<<'
  
    - name: InitEnv
      run: |
        sudo apt-get update
        sudo apt-get -y install pkg-config git subversion curl wget build-essential python xz-utils zip p7zip-full
    
    - name: ParsedIssueInfo
      run: |
        echo "Issue title: ${{ github.event.issue.title }}"
        echo "${{ fromJson(steps.parse.outputs.payload).commit_id }}"
        echo "${{ fromJson(steps.parse.outputs.payload).upload_depot_files.enable }}"
        echo "${{ fromJson(steps.parse.outputs.payload).upload_v8_files.enable }}"
        
    - name: CreateTar
      run: |
        7z a read.7z README.md 
    
    - name: Upload
      id: upload
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress read.7z 2>&1 | tee cowtransfer.log
        echo "::set-output name=url::$(cat cowtransfer.log | grep https)"
        echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
        
    - name: Close Issue
      uses: peter-evans/close-issue@v1
      with:
        issue-number: ${{ github.event.issue.number }}
        comment: |
          Auto close. Build with commit "${{ fromJson(steps.parse.outputs.payload).commit_id }}"
          download: "${{steps.upload.outputs.url}}"
